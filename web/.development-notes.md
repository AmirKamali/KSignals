# Development Guidelines

## API Calls

**IMPORTANT: Do NOT use JavaScript to make API calls to the backend.**

All API calls should be made server-side using C# Razor Pages with proper form postback handling. This ensures:
- Better security (no exposed tokens in client-side code)
- Proper server-side validation
- Clean separation of concerns
- Standard HTTP form handling

## Authentication & Protected Routes

### User Pages (Authenticated Routes)
All pages under `/user/` require authentication:
- **Route Structure**: Pages/User/ folder maps to /user/ URL path
- **Authentication**: Inherits from `AuthenticatedPageModel` base class
- **Redirect Behavior**: Unauthenticated users redirect to `/Login?returnUrl=<requested-page>`

### Authentication Check
Pages check for:
1. `ksignals_firebase_id` cookie (set during login)
2. `ksignals_jwt` cookie (set after backend authentication)

If neither exists, redirect to login with return URL.

### Example Pattern:

1. **PageModel (SetUsername.cshtml.cs)**:
   - Use `[BindProperty]` for form fields
   - Handle POST with `OnPostAsync()` method
   - Call backend via `BackendClient` service
   - Return `RedirectToPage()` on success or `Page()` with error message on failure

2. **View (SetUsername.cshtml)**:
   - Use `method="post"` on forms
   - Use `asp-for` for input binding
   - Display `Model.ErrorMessage` for validation errors

3. **JavaScript (minimal)**:
   - Only use for client-side enhancements (Firebase auth check, UI interactions)
   - Do NOT make fetch/axios calls to backend APIs
   - Populate hidden fields for server-side processing

### Benefits:
- Cookies for session management (secure, HttpOnly for tokens)
- Server-side validation
- No CORS issues
- Better error handling
- Standard HTML form behavior

## File Structure Changes

### Created Files:
- `Pages/User/AuthenticatedPageModel.cs` - Base class for authenticated pages
- `Pages/User/Username.cshtml` - Username setup page (moved from SetUsername.cshtml)
- `Pages/User/Username.cshtml.cs` - Page model for username setup

### Moved Files:
- `Pages/SetUsername.cshtml` → `Pages/User/Username.cshtml`
- `Pages/SetUsername.cshtml.cs` → `Pages/User/Username.cshtml.cs`

### Updated Files:
- `wwwroot/js/login.js` - Store Firebase ID in cookie, redirect to /user/username
- `wwwroot/js/site.js` - Clear Firebase ID cookie on logout
- `wwwroot/js/set-username.js` - Updated console log
- `Services/BackendClient.cs` - Added SetUsernameAsync method

## Cookie Management

The application uses cookies for session management:
- `ksignals_jwt` (HttpOnly) - JWT token from backend
- `ksignals_firebase_id` (HttpOnly) - Firebase user ID for authentication
- `ksignals_username` - User's username
- `ksignals_name` - User's display name
- `ksignals_email` - User's email

All cookies:
- Expire after 7 days
- Use `SameSite=Strict`
- Use `Secure=true` flag
