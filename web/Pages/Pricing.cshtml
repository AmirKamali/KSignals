@page
@model PricingModel
@{
    ViewData["Title"] = "Pricing";

    var featureMap = new Dictionary<string, string[]>
    {
        ["free"] = new[]
        {
            "Live market viewer",
            "Basic historical snapshots",
            "Email alerts (daily digest)"
        },
        ["core-data"] = new[]
        {
            "Live and historical order books",
            "Export-ready CSV and Parquet snapshots",
            "API and ClickHouse friendly schema",
            "Automated backfill + retention controls"
        }
    };

    var activePlan = Model.CurrentSubscription?.ActivePlan?.Code ?? string.Empty;
}

<main class="pricing-page">
    <section class="pricing-hero">
        <div class="container">
            <div class="pricing-hero-grid">
                <div class="hero-copy">
                    <p class="eyebrow">Subscriptions</p>
                    <h1>Start free, upgrade to Core Data</h1>
                    <p class="lede">
                        Begin with the Free tier and step into Core Data when you need full-resolution feeds and exports.
                    </p>
                    <div class="hero-pills">
                        <span class="pill">Stripe-secured checkout</span>
                        <span class="pill">Cancel anytime</span>
                        <span class="pill">Free forever</span>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
                    {
                        <div class="alert success">@Model.StatusMessage</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
                    {
                        <div class="alert error">@Model.ErrorMessage</div>
                    }
                </div>
                <div class="hero-panel">
                    <div class="panel-header">
                        <p>Live coverage</p>
                        <span class="badge hot">+240 tracked markets</span>
                    </div>
                    <div class="panel-body">
                        <div class="stat">
                            <p class="label">Latency</p>
                            <p class="value">~220ms</p>
                        </div>
                        <div class="stat">
                            <p class="label">Data freshness</p>
                            <p class="value">Live</p>
                        </div>
                        <div class="stat">
                            <p class="label">Signals per day</p>
                            <p class="value">3.1k</p>
                        </div>
                        <div class="stat">
                            <p class="label">Uptime (90d)</p>
                            <p class="value">99.95%</p>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <p>Stripe protected • Simple billing • Instant activation</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="plans" class="plan-section" data-cadence="@Model.SelectedCadence">
        <div class="container">
            <div class="section-header">
                <div>
                    <p class="eyebrow">Plans</p>
                    <h2>Pick your access level</h2>
                    <p class="lede">Stay on Free or move to Core Data for production-ready market coverage.</p>
                </div>
                @if (Model.CurrentSubscription?.ActivePlan != null)
                {
                    <div class="current-chip">
                        <span>Current</span>
                        <strong>@Model.CurrentSubscription.ActivePlan.Name</strong>
                        <small>@Model.CurrentSubscription.Status</small>
                    </div>
                }
            </div>

            <div class="billing-toggle" role="group" aria-label="Billing cadence selector">
                <button type="button" class="toggle-option" data-cadence="monthly">Monthly</button>
                <button type="button" class="toggle-option" data-cadence="annual">Annual billing</button>
            </div>

            <div class="plan-grid">
                @foreach (var tier in Model.Tiers)
                {
                    var monthlyPlan = tier.MonthlyPlan ?? tier.AnnualPlan;
                    var annualPlan = tier.AnnualPlan ?? tier.MonthlyPlan;
                    var selectedPlan = monthlyPlan ?? annualPlan;
                    if (selectedPlan == null)
                    {
                        continue;
                    }

                    var tierKey = string.IsNullOrWhiteSpace(tier.Tier) ? selectedPlan.Code : tier.Tier;
                    var isCurrent = string.Equals(activePlan, selectedPlan.Code, StringComparison.OrdinalIgnoreCase);
                    var isFree = selectedPlan.Amount <= 0;
                    var monthlyPriceLabel = monthlyPlan == null || monthlyPlan.Amount <= 0
                        ? "Free"
                        : $"${monthlyPlan.Amount:0} / {monthlyPlan.Interval}";
                    var annualPriceLabel = annualPlan == null || annualPlan.Amount <= 0
                        ? "Free"
                        : $"${annualPlan.Amount:0} / {annualPlan.Interval}";
                    var features = featureMap.TryGetValue(tierKey, out var mapped)
                        ? mapped
                        : new[] { "Live data", "Alerts", "Priority support" };
                    var isCoreTier = string.Equals(tierKey, "core-data", StringComparison.OrdinalIgnoreCase);
                <div class="plan-card @(isCurrent ? "plan-card-active" : string.Empty)" data-tier="@tierKey">
                    <div class="plan-top">
                        <div class="plan-labels">
                            <p class="eyebrow">@selectedPlan.Code</p>
                            <h3>@(string.IsNullOrWhiteSpace(tier.Name) ? selectedPlan.Name : tier.Name)</h3>
                            <p class="plan-description">@selectedPlan.Description</p>
                        </div>
                        <div class="price-row">
                            <span class="price price-monthly">@monthlyPriceLabel</span>
                            <span class="price price-annual">@annualPriceLabel</span>
                            @if (isCurrent)
                            {
                                <span class="badge success">Current plan</span>
                            }
                        </div>
                    </div>
                    <ul class="feature-list">
                        @foreach (var feature in features)
                        {
                            <li>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>@feature</span>
                            </li>
                        }
                    </ul>
                    <div class="plan-actions">
                        @if (isCurrent && Model.CurrentSubscription?.StripeCustomerId != null)
                        {
                            <form method="post" asp-page-handler="Portal">
                                <button type="submit" class="btn btn-outline">Manage billing</button>
                            </form>
                        }
                        @if (isCoreTier && !isCurrent)
                        {
                            <a href="@Model.CoreDataPaymentLink"
                               class="btn btn-primary cadence-link"
                               data-monthly-href="@Model.CoreDataPaymentLink"
                               data-annual-href="@Model.CoreDataAnnualPaymentLink">
                                <span class="cta-label cta-monthly">Choose monthly</span>
                                <span class="cta-label cta-annual">Choose annual</span>
                            </a>
                        }
                        else if (!isCoreTier)
                        {
                            <form method="post" asp-page-handler="Checkout">
                                <input type="hidden"
                                       name="planCode"
                                       value="@monthlyPlan?.Code ?? annualPlan?.Code"
                                       class="cadence-plan-code"
                                       data-monthly-code="@monthlyPlan?.Code"
                                       data-annual-code="@annualPlan?.Code" />
                                <input type="hidden" name="cadence" value="@Model.SelectedCadence" class="cadence-value" />
                                <button type="submit" class="btn btn-primary">
                                    <span class="cta-label cta-monthly">@((isFree ? "Start for free" : "Choose monthly"))</span>
                                    <span class="cta-label cta-annual">@((isFree ? "Start for free" : "Choose annual"))</span>
                                </button>
                            </form>
                        }
                    </div>
                </div>
                }
            </div>
        </div>
    </section>

    @if (Model.CurrentSubscription?.Events?.Any() == true)
    {
        <section class="history-section">
            <div class="container">
                <div class="section-header">
                    <div>
                        <p class="eyebrow">History</p>
                        <h2>Subscription activity</h2>
                        <p class="lede">We keep a trail of upgrades, downgrades, and billing events.</p>
                    </div>
                </div>
                <div class="timeline">
                    @foreach (var evt in Model.CurrentSubscription.Events.OrderByDescending(e => e.CreatedAt))
                    {
                        <div class="timeline-item">
                            <div class="dot"></div>
                            <div>
                                <p class="timeline-title">@evt.EventType</p>
                                @if (!string.IsNullOrWhiteSpace(evt.Notes))
                                {
                                    <p class="timeline-notes">@evt.Notes</p>
                                }
                                <p class="timeline-date">@evt.CreatedAt.ToString("MMM dd, yyyy HH:mm")</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>
    }
</main>

@section Scripts {
    <script>
        (() => {
            const section = document.querySelector('.plan-section');
            const toggleButtons = document.querySelectorAll('.billing-toggle .toggle-option');
            if (!section || toggleButtons.length === 0) return;

            const setCadence = (cadence) => {
                const normalized = cadence === 'annual' ? 'annual' : 'monthly';
                section.dataset.cadence = normalized;

                toggleButtons.forEach(btn => {
                    const isActive = (btn.dataset.cadence || 'monthly') === normalized;
                    btn.classList.toggle('active', isActive);
                });

                document.querySelectorAll('.cadence-plan-code').forEach(input => {
                    const monthly = input.dataset.monthlyCode;
                    const annual = input.dataset.annualCode;
                    input.value = normalized === 'annual' && annual ? annual : monthly || annual || '';
                });

                document.querySelectorAll('.cadence-value').forEach(input => {
                    input.value = normalized;
                });

                document.querySelectorAll('.cadence-link').forEach(link => {
                    const monthly = link.dataset.monthlyHref;
                    const annual = link.dataset.annualHref;
                    link.href = normalized === 'annual' && annual ? annual : monthly || annual || '#';
                });
            };

            toggleButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    setCadence(btn.dataset.cadence || 'monthly');
                });
            });

            setCadence(section.dataset.cadence || 'monthly');
        })();
    </script>
}
