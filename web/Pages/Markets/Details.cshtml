@page "/marketDetails"
@using KSignals.DTO
@model web_asp.Pages.Markets.DetailsModel
@{
    var eventDetails = Model.EventDetails;
    var eventData = eventDetails?.Event;
    var market = eventDetails?.Markets?.FirstOrDefault();
    ViewData["Title"] = eventData != null ? $"{eventData.Title} details" : "Event Details";

    var yesPrice = market != null ? (market.LastPrice > 0 ? market.LastPrice : market.YesBid) : 0m;
    var noPrice = market != null ? (market.NoBid > 0 ? market.NoBid : Math.Max(0m, 100m - yesPrice)) : 0m;
    var previousYes = market != null && market.PreviousYesBid > 0 ? (decimal?)market.PreviousYesBid : null;
    var previousNo = previousYes.HasValue ? 100m - previousYes.Value : (decimal?)null;
    var yesTrend = market != null ? GetTrendInfo(yesPrice, previousYes) : null;
    var noTrend = market != null ? GetTrendInfo(noPrice, previousNo) : null;

    // Calculate totals across all markets in the event
    var totalLiquidity = eventDetails?.Markets?.Sum(m => m.Liquidity) ?? 0m;
    var totalVolume = eventDetails?.Markets?.Sum(m => m.Volume24h > 0 ? m.Volume24h : m.Volume) ?? 0m;
}

<main class="detailsPage">
    <div class="container">
        <a class="backLink" href="/markets">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Back to markets
        </a>

        @if (eventData == null || market == null)
        {
            <div class="emptyState">
                <h1>Event not found</h1>
                <p>Try selecting a different event from the list.</p>
            </div>
        }
        else
        {
            <header class="detailsHeader">
                <div>
                    <h1 class="detailsTitle">@TitleFormatter.FormatTitle(eventData.Title)</h1>
                    @if (!string.IsNullOrWhiteSpace(eventData.SubTitle))
                    {
                        <p class="detailsSubtitle">@eventData.SubTitle</p>
                    }
                    <div class="pillRow">
                        <span class="statusPill success">@market.Status?.ToUpperInvariant()</span>
                        <span class="statusPill muted">@FormatCloseTime(market.CloseTime)</span>
                        @if (!string.IsNullOrWhiteSpace(eventData.Category))
                        {
                            <span class="statusPill outline">@eventData.Category</span>
                        }
                        <a class="statusPill outline" target="_blank" rel="noopener noreferrer" href="https://kalshi.com/?search=@market.Ticker">
                            Open on Kalshi
                        </a>
                    </div>
                </div>
                <div class="priceSummary">
                    <div class="summaryLine">
                        <span class="label">Kalshi</span>
                        <a class="statusPill outline" target="_blank" rel="noopener noreferrer" href="https://kalshi.com/?search=@market.Ticker">
                            Open on Kalshi
                        </a>
                    </div>
                    <div class="summaryLine">
                        <span class="label">Last trade</span>
                        <span class="value">@((market.LastPrice > 0 ? market.LastPrice : yesPrice).ToString("0.#"))&cent;</span>
                    </div>
                    <div class="summaryLine">
                        <span class="label">Open interest</span>
                        <span class="value">@(market.OpenInterest.ToString("N0"))</span>
                    </div>
                    <div class="summaryLine">
                        <span class="label">Total volume</span>
                        <span class="value">@(totalVolume.ToString("N0"))</span>
                    </div>
                </div>
            </header>

            <section class="detailsGrid">
                <div class="statCard">
                    <h3>Total liquidity</h3>
                    <p class="statValue">@(totalLiquidity.ToString("N0"))</p>
                    <p class="statSub">Open interest @(market.OpenInterest.ToString("N0"))</p>
                </div>
                <div class="statCard">
                    <h3>Total volume</h3>
                    <p class="statValue">@(totalVolume.ToString("N0"))</p>
                    <p class="statSub">All markets combined</p>
                </div>
                <div class="statCard">
                    <h3>Status</h3>
                    <p class="statValue">@market.Status</p>
                    <p class="statSub">@FormatCloseTime(market.CloseTime)</p>
                </div>
            </section>

            @if (eventDetails?.Markets != null && eventDetails.Markets.Count > 0)
            {
                <section class="marketsSection">
                    <h2 class="sectionTitle">Markets in this Event</h2>
                    <div class="marketsGrid">
                        @foreach (var mkt in eventDetails.Markets)
                        {
                            var mktYesPrice = mkt.LastPrice > 0 ? mkt.LastPrice : mkt.YesBid;
                            var mktNoPrice = mkt.NoBid > 0 ? mkt.NoBid : Math.Max(0, 100 - mktYesPrice);
                            var mktPreviousYes = mkt.PreviousYesBid > 0 ? (decimal?)mkt.PreviousYesBid : null;
                            var mktYesTrend = GetTrendInfo(mktYesPrice, mktPreviousYes);

                            <div class="marketCard">
                                <div class="marketCardContent">
                                    <div class="marketCardHeader">
                                        <div class="marketCardTitle">
                                            @if (!string.IsNullOrWhiteSpace(mkt.YesSubTitle) || !string.IsNullOrWhiteSpace(mkt.NoSubTitle))
                                            {
                                                <span class="yesLabel">@mkt.YesSubTitle</span>
                                                @if (!string.IsNullOrWhiteSpace(mkt.NoSubTitle))
                                                {
                                                    <span class="separator">vs</span>
                                                    <span class="noLabel">@mkt.NoSubTitle</span>
                                                }
                                            }
                                            else if (!string.IsNullOrWhiteSpace(mkt.SubTitle))
                                            {
                                                <span>@mkt.SubTitle</span>
                                            }
                                            else
                                            {
                                                <span>@mkt.Ticker</span>
                                            }
                                        </div>
                                        <span class="statusBadge @(mkt.Status?.ToLowerInvariant())">@mkt.Status</span>
                                    </div>

                                    <div class="marketCardStats">
                                        <div class="statGroup">
                                            <div class="statItem">
                                                <span class="statLabel">Yes Price</span>
                                                <div class="statValueGroup">
                                                    <span class="statValue yes">@(mktYesPrice.ToString("0.#"))¢</span>
                                                    @if (mktYesTrend.HasValue && mktYesTrend.Value.diff != 0)
                                                    {
                                                        var directionClass = mktYesTrend.Value.direction == "up" ? "trendUp" : "trendDown";
                                                        <span class="trendBadge @directionClass">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="currentColor" style="transform:@(mktYesTrend.Value.direction == "down" ? "rotate(180deg)" : "none");">
                                                                <path d="M12 16l-6-6h12z"></path>
                                                            </svg>
                                                            @FormatDelta(mktYesTrend.Value.diff)¢
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="statItem">
                                                <span class="statLabel">No Price</span>
                                                <span class="statValue no">@(mktNoPrice.ToString("0.#"))¢</span>
                                            </div>
                                        </div>

                                        <div class="statGroup">
                                            <div class="statItem">
                                                <span class="statLabel">Volume</span>
                                                <span class="statValue">@(mkt.Volume.ToString("N0"))</span>
                                            </div>
                                            <div class="statItem">
                                                <span class="statLabel">Open Interest</span>
                                                <span class="statValue">@(mkt.OpenInterest.ToString("N0"))</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="marketCardFooter">
                                        <div class="bidAsk">
                                            <span class="bidAskLabel">Bid/Ask:</span>
                                            <span class="bidAskValues">
                                                @(mkt.YesBid.ToString("0.#"))¢ / @(mkt.YesAsk.ToString("0.#"))¢
                                            </span>
                                        </div>
                                        <div class="closeTime">
                                            @FormatCloseTime(mkt.CloseTime)
                                        </div>
                                    </div>
                                </div>
                                <div class="marketCardChart">
                                    <canvas id="chart-@mkt.Ticker" data-ticker="@mkt.Ticker"></canvas>
                                </div>
                            </div>
                        }
                    </div>
                </section>
            }

            <section class="detailPanels">
                <div class="panel timelineCard">
                    <h3>Timeline</h3>
                    <dl>
                        <div>
                            <dt>Opens</dt>
                            <dd>@FormatDate(market.OpenTime)</dd>
                        </div>
                        <div>
                            <dt>Closes</dt>
                            <dd>@FormatDate(market.CloseTime)</dd>
                        </div>
                        <div>
                            <dt>Expiration</dt>
                            <dd>@FormatDate(market.ExpectedExpirationTime)</dd>
                        </div>
                        <div>
                            <dt>Latest expiration</dt>
                            <dd>@FormatDate(market.LatestExpirationTime)</dd>
                        </div>
                    </dl>
                </div>

                <div class="panel orderbookCard">
                    <h3>Orderbook</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Side</th>
                                <th>Bid</th>
                                <th>Ask</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Yes</td>
                                <td>@(market.YesBid > 0 ? $"{market.YesBid:0.#}¢" : "—")</td>
                                <td>@(market.YesAsk > 0 ? $"{market.YesAsk:0.#}¢" : "—")</td>
                            </tr>
                            <tr>
                                <td>No</td>
                                <td>@(market.NoBid > 0 ? $"{market.NoBid:0.#}¢" : "—")</td>
                                <td>@(market.NoAsk > 0 ? $"{market.NoAsk:0.#}¢" : "—")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        }
    </div>
</main>

@functions {
    private static string FormatCloseTime(DateTime closeTime)
    {
        if (closeTime == default) return "Close time unavailable";

        var now = DateTime.UtcNow;
        var diff = closeTime - now;
        var absMinutes = Math.Max(1, (int)Math.Round(Math.Abs(diff.TotalMinutes)));
        var value = absMinutes;
        var unit = "minutes";

        if (absMinutes >= 60)
        {
            var hours = (int)Math.Round(absMinutes / 60.0);
            if (hours < 48)
            {
                value = hours;
                unit = hours == 1 ? "hour" : "hours";
            }
            else
            {
                var days = (int)Math.Round(hours / 24.0);
                value = days;
                unit = days == 1 ? "day" : "days";
            }
        }
        else if (absMinutes == 1)
        {
            unit = "minute";
        }

        return diff >= TimeSpan.Zero
            ? $"Closes in {value} {unit}"
            : $"Closed {value} {unit} ago";
    }

    private static (string direction, decimal diff)? GetTrendInfo(decimal current, decimal? previous)
    {
        if (!previous.HasValue) return null;
        var diff = current - previous.Value;
        if (diff == 0) return ("flat", 0);
        return diff > 0 ? ("up", diff) : ("down", diff);
    }

    private static string FormatDelta(decimal diff)
    {
        var abs = Math.Abs(diff);
        if (abs >= 1)
        {
            return Math.Round(abs).ToString("0");
        }
        return abs.ToString("0.00");
    }

    private static string FormatDate(DateTime? dateTime)
    {
        if (!dateTime.HasValue || dateTime.Value == default) return "—";
        return dateTime.Value.ToUniversalTime().ToString("MMM d, yyyy h:mm tt 'UTC'");
    }

    private static string FormatDate(DateTime dateTime)
        {
        if (dateTime == default) return "—";
        return dateTime.ToUniversalTime().ToString("MMM d, yyyy h:mm tt 'UTC'");
    }
}

@section Scripts {
    <script>
        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const canvases = document.querySelectorAll('canvas[data-ticker]');

            canvases.forEach(canvas => {
                const ticker = canvas.getAttribute('data-ticker');
                if (!ticker) return;

                // Fetch chart data from API
                fetch(`${window.backendBaseUrl}/api/charts?ticker=${encodeURIComponent(ticker)}`)
                    .then(response => response.json())
                    .then(data => {
                        const ctx = canvas.getContext('2d');

                        // Prepare data for Chart.js
                        const labels = data.dataPoints.map(point => {
                            const date = new Date(point.timestamp);
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        });

                        const values = data.dataPoints.map(point => point.value);

                        // Create gradient
                        const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                        gradient.addColorStop(0, 'rgba(37, 99, 235, 0.3)');
                        gradient.addColorStop(1, 'rgba(37, 99, 235, 0.01)');

                        // Create chart
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Price (¢)',
                                    data: values,
                                    borderColor: '#2563eb',
                                    backgroundColor: gradient,
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4, // Smooth curves
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    pointHoverBackgroundColor: '#2563eb',
                                    pointHoverBorderColor: '#fff',
                                    pointHoverBorderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                        padding: 12,
                                        titleColor: '#fff',
                                        bodyColor: '#fff',
                                        borderColor: '#2563eb',
                                        borderWidth: 1,
                                        displayColors: false,
                                        callbacks: {
                                            label: function(context) {
                                                return context.parsed.y.toFixed(2) + '¢';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        grid: {
                                            display: false
                                        },
                                        ticks: {
                                            maxRotation: 0,
                                            autoSkip: true,
                                            maxTicksLimit: 6,
                                            color: '#64748b',
                                            font: {
                                                size: 11
                                            }
                                        }
                                    },
                                    y: {
                                        display: true,
                                        grid: {
                                            color: 'rgba(226, 232, 240, 0.5)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            color: '#64748b',
                                            font: {
                                                size: 11
                                            },
                                            callback: function(value) {
                                                return value + '¢';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => {
                        console.error(`Failed to load chart for ${ticker}:`, error);
                        // Display error message in canvas
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#64748b';
                        ctx.font = '14px Outfit, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('Chart unavailable', canvas.width / 2, canvas.height / 2);
                    });
            });
        });
    </script>
}
