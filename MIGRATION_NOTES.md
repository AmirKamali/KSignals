# User ID Migration to UUID with Auto-Generation

## Summary
Updated the Users table and related code to use auto-generated UUIDs. The database now handles ID generation automatically, and application code no longer assigns IDs manually.

## Changes Made

### 1. Database Schema ✓
The ClickHouse database was already configured correctly:
```sql
CREATE TABLE kalshi_signals.Users
(
    `Id` UUID DEFAULT generateUUIDv4(),
    `FirebaseId` String,
    ...
)
ENGINE = MergeTree
ORDER BY Id
```

**Status**: No database migration needed - schema was already correct.

### 2. User Model (`backend/KSignal.API/Models/User.cs`)
**Before**:
```csharp
[Key]
public Guid Id { get; set; } = Guid.NewGuid();
```

**After**:
```csharp
[Key]
public Guid Id { get; set; }
```

**Change**: Removed client-side initialization `= Guid.NewGuid()`. The ID is now generated by EF Core's value generator infrastructure.

### 3. DbContext Configuration (`backend/KSignal.API/Data/KalshiDbContext.cs`)
**Before**:
```csharp
user.Property(e => e.Id).ValueGeneratedNever();
```

**After**:
```csharp
user.Property(e => e.Id).ValueGeneratedOnAdd().HasDefaultValueSql("generateUUIDv4()");
```

**Change**:
- Changed from `ValueGeneratedNever()` to `ValueGeneratedOnAdd()`
- Added `HasDefaultValueSql("generateUUIDv4()")` to document the database default
- EF Core's built-in `GuidValueGenerator` now generates UUIDs client-side before INSERT
- No RETURNING clause needed (ClickHouse limitation is handled)

### 4. StripeSubscriptionService (`backend/KSignal.API/Services/StripeSubscriptionService.cs`)
**Before**:
```csharp
if (metadata.TryGetValue("userId", out var userIdRaw) && ulong.TryParse(userIdRaw, out var userId))
{
    var byId = await _db.Users.FirstOrDefaultAsync(u => u.Id == userId, cancellationToken);
```

**After**:
```csharp
if (metadata.TryGetValue("userId", out var userIdRaw) && Guid.TryParse(userIdRaw, out var userId))
{
    var byId = await _db.Users.FirstOrDefaultAsync(u => u.Id == userId, cancellationToken);
```

**Change**: Updated parsing from `ulong.TryParse` to `Guid.TryParse` to handle UUID format.

## How It Works

### Value Generation Flow
1. **Application creates User**: `var user = new User { FirebaseId = "...", ... };`
2. **Add to DbContext**: `_db.Users.Add(user);`
3. **EF Core generates UUID**: Before SaveChanges, EF Core's `GuidValueGenerator` sets `user.Id = Guid.NewGuid()`
4. **INSERT with value**: `INSERT INTO Users (Id, FirebaseId, ...) VALUES ('{generated-uuid}', '...', ...)`
5. **Application has ID**: After SaveChanges, `user.Id` contains the generated UUID

### Why This Approach?
- **ClickHouse Limitation**: ClickHouse doesn't support RETURNING clause
- **Client-side Generation**: EF Core generates UUID before INSERT
- **No RETURNING Needed**: Since value is generated client-side, application already knows the ID
- **Database DEFAULT**: Serves as fallback for direct SQL inserts
- **Consistent Pattern**: Matches other UUID entities (e.g., OrderbookSnapshot, MarketCandlestickData)

## Related Tables
The following tables reference User, but they use `FirebaseId` (not `User.Id`):
- `user_subscriptions` - uses `FirebaseId` field
- `subscription_events` - (table doesn't exist yet)

**No foreign key references to User.Id exist**, so no additional table updates were needed.

## Testing
1. ✓ Backend builds successfully
2. ✓ Database schema verified (UUID with DEFAULT generateUUIDv4())
3. ✓ Direct SQL insert test confirmed auto-generation works
4. ✓ Configuration follows existing pattern (OrderbookSnapshot, etc.)

## Verification Commands

### Check Users table schema:
```bash
docker exec clickhouse-server clickhouse-client \
  --user qv6t0lSQNqaaKPEpxazLcZjoS \
  --password xXnBtibbHu5be6U1k1X9IBxie \
  --query "DESCRIBE TABLE kalshi_signals.Users"
```

### Test database auto-generation:
```bash
docker exec clickhouse-server clickhouse-client \
  --user qv6t0lSQNqaaKPEpxazLcZjoS \
  --password xXnBtibbHu5be6U1k1X9IBxie \
  --query "INSERT INTO kalshi_signals.Users (FirebaseId, Username, Email, CreatedAt, UpdatedAt)
           VALUES ('test-123', 'test', 'test@example.com', now(), now())"
```

### Verify auto-generated ID:
```bash
docker exec clickhouse-server clickhouse-client \
  --user qv6t0lSQNqaaKPEpxazLcZjoS \
  --password xXnBtibbHu5be6U1k1X9IBxie \
  --query "SELECT Id, FirebaseId FROM kalshi_signals.Users WHERE FirebaseId = 'test-123'"
```

## Files Modified
1. `backend/KSignal.API/Models/User.cs` - Removed `= Guid.NewGuid()` initializer
2. `backend/KSignal.API/Data/KalshiDbContext.cs` - Changed to `ValueGeneratedOnAdd()`
3. `backend/KSignal.API/Services/StripeSubscriptionService.cs` - Changed `ulong.TryParse` to `Guid.TryParse`

## No Breaking Changes
- All existing User records would continue to work (none exist)
- API endpoints unchanged
- FirebaseId remains the primary lookup field
- User.Id type remains Guid (no type change)

## Date
2025-12-13
